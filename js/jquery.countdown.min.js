(function ($) {

    function parseDate(input) {
        if (input instanceof Date) return input;
        if (typeof input === "string") {
            // Convert "yyyy-mm-dd" â†’ "yyyy/mm/dd" to avoid Safari issue
            input = input.replace(/-/g, "/");
        }
        return new Date(input);
    }

    function diffTime(now, future) {
        let years = future.getFullYear() - now.getFullYear();
        let months = future.getMonth() - now.getMonth();
        let days = future.getDate() - now.getDate();
        let hours = future.getHours() - now.getHours();
        let minutes = future.getMinutes() - now.getMinutes();
        let seconds = future.getSeconds() - now.getSeconds();

        // Normalize seconds
        if (seconds < 0) {
            seconds += 60;
            minutes--;
        }

        // Normalize minutes
        if (minutes < 0) {
            minutes += 60;
            hours--;
        }

        // Normalize hours
        if (hours < 0) {
            hours += 24;
            days--;
        }

        // Normalize days
        if (days < 0) {
            let prevMonth = new Date(future.getFullYear(), future.getMonth(), 0);
            days += prevMonth.getDate();
            months--;
        }

        // Normalize months
        if (months < 0) {
            months += 12;
            years--;
        }

        // For total seconds (raw countdown)
        const totalSeconds = Math.floor((future - now) / 1000);
        const totalMinutes = Math.floor(totalSeconds / 60);
        const totalHours = Math.floor(totalMinutes / 60);
        const totalDays = Math.floor(totalHours / 24);

        return {
            years, months, days,
            hours, minutes, seconds,
            totalSeconds, totalMinutes, totalHours, totalDays
        };
    }


    $.fn.countdown = function (finalDate, callback) {
        const end = parseDate(finalDate);

        const update = (el) => {
            const now = new Date();
            let result = diffTime(now, end);

            if (result.totalSeconds <= 0) {
                result = {
                    years: 0, months: 0, days: 0,
                    hours: 0, minutes: 0, seconds: 0,
                    totalSeconds: 0, totalMinutes: 0,
                    totalHours: 0, totalDays: 0
                };
                clearInterval(el.timer);
            }

            callback && callback(result);
        };

        return this.each(function () {
            const el = this;
            update(el);
            el.timer = setInterval(() => update(el), 1000);
        });
    };

})(jQuery);
